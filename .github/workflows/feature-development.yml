name: Feature Development Workflow

on:
  push:
    branches: [ feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  feature-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup GitHub CLI
      run: |
        echo "Setting up GitHub CLI..."
        # GitHub CLI is pre-installed on ubuntu-latest runners
      
    - name: Detect changes
      id: changes
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -E '^ui/' > /dev/null; then
          echo "frontend_changed=true" >> $GITHUB_OUTPUT
        fi
        if git diff --name-only HEAD~1 HEAD | grep -E '^(api/|agent/|scorer/|graph/|data/|tests/)' > /dev/null; then
          echo "backend_changed=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Validate frontend
      if: steps.changes.outputs.frontend_changed == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Frontend changes detected, running frontend validation..."
        # Trigger frontend CI workflow
        gh workflow run ci-frontend.yml --ref ${{ github.ref }}
        echo "Frontend validation triggered"
        
    - name: Validate backend
      if: steps.changes.outputs.backend_changed == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Backend changes detected, running backend validation..."
        # Trigger backend CI workflow
        gh workflow run ci-backend.yml --ref ${{ github.ref }}
        echo "Backend validation triggered"
        
    - name: Run integration tests
      if: steps.changes.outputs.frontend_changed == 'true' || steps.changes.outputs.backend_changed == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Running integration tests for feature branch..."
        # Trigger integration CI workflow
        gh workflow run ci-integration.yml --ref ${{ github.ref }}
        echo "Integration tests triggered"

  # Security scanning is handled by the dedicated security.yml workflow
  # which runs automatically on pushes to feature branches

  build-and-deploy-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build frontend
      run: |
        echo "Building frontend for preview deployment..."
        # This would build and deploy to a preview environment
        echo "Preview deployment completed"
        
    - name: Comment PR with preview link
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸš€ Preview deployment ready! Check out your changes at: [Preview Link](https://preview.example.com)'
          })
